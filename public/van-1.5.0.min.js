let e,t,l,n,r,o=Object.getPrototypeOf,s={isConnected:1},f={},i=o(s),u=o(o),h=(e,t,l,n)=>(e??(setTimeout(l,n),new Set)).add(t),d=(e,t,n)=>{let r=l;l=t;try{return e(n)}catch(e){return console.error(e),n}finally{l=r}},a=e=>e.filter(e=>e.t?.isConnected),w=e=>r=h(r,e,()=>{for(let e of r)e.l=a(e.l),e.o=a(e.o);r=null},1e3),_={get val(){return l?.i?.add(this),this.u},get oldVal(){return l?.i?.add(this),this.h},set val(n){l?._?.add(this),n!==this.u&&(this.u=n,this.l.length+this.o.length?(t?.add(this),e=h(e,this,j)):this.h=n)}},c=e=>({__proto__:_,u:e,h:e,l:[],o:[]}),S=(e,t)=>{let l={i:new Set,_:new Set},r={f:e},o=n;n=[];let s=d(e,l,t);s=(s??document).nodeType?s:new Text(s);for(let e of l.i)l._.has(e)||(w(e),e.l.push(r));for(let e of n)e.t=s;return n=o,r.t=s},g=(e,t=c(),l)=>{let r={i:new Set,_:new Set},o={f:e,s:t};o.t=l??n?.push(o)??s,t.val=d(e,r,t.u);for(let e of r.i)r._.has(e)||(w(e),e.o.push(o));return t},y=(e,...t)=>{for(let l of t.flat(1/0)){let t=o(l??0),n=t===_?S(()=>l.val):t===u?S(l):l;null!=n&&e.append(n)}return e},b=(e,t,...l)=>{let[n,...r]=o(l[0]??0)===i?l:[{},...l],s=e?document.createElementNS(e,t):document.createElement(t);for(let[e,l]of Object.entries(n)){let n=t=>t?Object.getOwnPropertyDescriptor(t,e)??n(o(t)):null,r=t+","+e,i=f[r]??(f[r]=n(o(s))?.set??0),h=e.startsWith("on")?(t,l)=>{let n=e.slice(2);s.removeEventListener(n,l),s.addEventListener(n,t)}:i?i.bind(s):s.setAttribute.bind(s,e),d=o(l??0);e.startsWith("on")||d===u&&(l=g(l),d=_),d===_?S(()=>(h(l.val,l.h),s)):h(l)}return y(s,...r)},m=e=>({get:(t,l)=>b.bind(null,e,l)}),v=new Proxy(e=>new Proxy(b,m(e)),m()),x=(e,t)=>t?t!==e&&e.replaceWith(t):e.remove(),j=()=>{let l=0,n=[...e].filter(e=>e.u!==e.h);do{t=new Set;for(let e of new Set(n.flatMap(e=>e.o=a(e.o))))g(e.f,e.s,e.t),e.t=null}while(++l<100&&(n=[...t]).length);let r=[...e].filter(e=>e.u!==e.h);e=null;for(let e of new Set(r.flatMap(e=>e.l=a(e.l))))x(e.t,S(e.f,e.t)),e.t=null;for(let e of r)e.h=e.u};export default{add:y,tags:v,state:c,derive:g,hydrate:(e,t)=>x(e,S(t,e))};